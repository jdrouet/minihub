name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo test --all

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    # NOTE: Enable this job starting at M1 when there are tests to measure.
    # For M0 (scaffold), coverage is expected to be 0%.
    # Uncomment the 'if' line below once M1 is complete to make this blocking.
    # if: false  # Remove this line at M1
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov
      - name: Run coverage
        run: cargo llvm-cov --workspace --lcov --output-path lcov.info
      - name: Coverage summary
        run: cargo llvm-cov --workspace --no-run
      # --- Threshold enforcement (update per milestone) ---
      # M0: no threshold (scaffold)
      # M1: 40%
      # M2: 60%
      # M3: 70%
      # M4: 70%
      # M5: 80%
      #
      # To enforce a threshold, uncomment and adjust:
      # - name: Check coverage threshold
      #   run: |
      #     THRESHOLD=40
      #     COV=$(cargo llvm-cov --workspace --no-run 2>&1 | grep -oP 'TOTAL.*?(\d+\.\d+)%' | grep -oP '\d+\.\d+' | tail -1)
      #     echo "Coverage: ${COV}%"
      #     if (( $(echo "$COV < $THRESHOLD" | bc -l) )); then
      #       echo "Coverage ${COV}% is below threshold ${THRESHOLD}%"
      #       exit 1
      #     fi

# --- CI evolution plan ---
#
# M0 (current):
#   - All jobs run but may fail on empty crates (expected).
#   - Coverage job has no threshold.
#
# M1 (domain + app core):
#   - All jobs should pass.
#   - Enable coverage threshold at 40%.
#
# M2 (HTTP + storage):
#   - Raise coverage threshold to 60%.
#   - Consider adding an integration test job with SQLite.
#
# M3 (events + automations):
#   - Raise coverage threshold to 70%.
#
# M4 (virtual integration):
#   - Coverage threshold stays at 70%.
#   - Add an end-to-end smoke test job if feasible.
#
# M5 (polish):
#   - Raise coverage threshold to 80%.
#   - Consider adding audit job: `cargo audit`.
#   - Consider adding MSRV check job.
#
# M6 (MQTT - stretch):
#   - MQTT tests may need a broker service container.
#   - Add `services: mosquitto` to the test job if needed.
